<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SeedReap</title>
    <link rel="icon" type="image/x-icon" href="/logo.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: {
                            900: '#1a1a2e',
                            800: '#16213e',
                            700: '#0f3460',
                            600: '#1a2744',
                            500: '#12192e',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes pulse-opacity {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-opacity {
            animation: pulse-opacity 1.5s ease-in-out infinite;
        }
        .sparkline path.line {
            fill: none;
            stroke: #22c55e;
            stroke-width: 2;
        }
        .sparkline .area {
            fill: rgba(34, 197, 94, 0.2);
            stroke: none;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a2e; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }
    </style>
</head>
<body class="bg-dark-900 text-gray-100 min-h-screen font-sans">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-6">
        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pb-4 sm:pb-6 border-b border-gray-700 mb-6">
            <h1 class="text-xl sm:text-2xl font-semibold flex items-center gap-3">
                <img src="/logo.svg" alt="SeedReap" class="w-8 h-8 sm:w-10 sm:h-10">
                SeedReap
            </h1>
            <div class="flex items-center gap-3">
                <button onclick="refresh()" class="bg-dark-700 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm transition-colors">
                    Refresh
                </button>
                <span id="status" class="bg-green-600 text-white px-3 py-1 rounded-full text-sm">
                    Connecting...
                </span>
            </div>
        </header>

        <!-- Transfer Status Bar -->
        <div class="bg-gradient-to-br from-dark-700 to-dark-800 border border-gray-700 rounded-lg p-4 mb-6">
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 sm:gap-6">
                <div class="flex items-center gap-3">
                    <span id="transfer-icon" class="text-2xl cursor-help" title="Idle">●</span>
                    <div>
                        <div class="text-xs text-gray-400 uppercase tracking-wide">Files</div>
                        <div class="text-lg sm:text-xl font-semibold" id="transfer-files">
                            <span id="files-done">0</span><span id="files-progress" class="text-yellow-400"></span><span class="text-gray-400">/</span><span id="files-total">0</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex-1">
                        <div class="text-xs text-gray-400 uppercase tracking-wide flex items-center gap-2">
                            Transfer Rate
                            <button id="speed-unit-btn" onclick="toggleSpeedUnit()" class="text-xs bg-dark-700 hover:bg-dark-600 px-1.5 py-0.5 rounded transition-colors" title="Click to switch units">MB/s</button>
                        </div>
                        <div class="text-lg sm:text-xl font-semibold" id="transfer-rate">
                            <span class="text-gray-500">Idle</span>
                        </div>
                    </div>
                    <svg class="sparkline w-20 sm:w-28 h-8 hidden sm:block" id="sparkline" viewBox="0 0 120 35" preserveAspectRatio="none">
                        <path class="area" d=""></path>
                        <path class="line" d=""></path>
                    </svg>
                </div>
                <div>
                    <div class="text-xs text-gray-400 uppercase tracking-wide">Progress</div>
                    <div class="text-lg sm:text-xl font-semibold" id="transfer-total">
                        <span id="total-transferred">0 B</span>
                        <span class="text-gray-400 text-sm sm:text-base">/</span>
                        <span id="total-size">0 B</span>
                    </div>
                </div>
                <div>
                    <div class="text-xs text-gray-400 uppercase tracking-wide">ETA</div>
                    <div class="text-lg sm:text-xl font-semibold" id="transfer-eta">
                        <span class="eta-value">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
            <div class="bg-dark-800 p-4 rounded-lg border border-gray-700">
                <h3 class="text-xs text-gray-400 uppercase tracking-wide mb-2">Total Tracked</h3>
                <div class="text-2xl sm:text-3xl font-semibold" id="stat-total">-</div>
            </div>
            <div class="bg-dark-800 p-4 rounded-lg border border-gray-700">
                <h3 class="text-xs text-gray-400 uppercase tracking-wide mb-2">Downloading</h3>
                <div class="text-2xl sm:text-3xl font-semibold text-blue-400" id="stat-downloading">-</div>
            </div>
            <div class="bg-dark-800 p-4 rounded-lg border border-gray-700">
                <h3 class="text-xs text-gray-400 uppercase tracking-wide mb-2">Syncing</h3>
                <div class="text-2xl sm:text-3xl font-semibold text-yellow-400" id="stat-syncing">-</div>
            </div>
            <div class="bg-dark-800 p-4 rounded-lg border border-gray-700">
                <h3 class="text-xs text-gray-400 uppercase tracking-wide mb-2">Complete</h3>
                <div class="text-2xl sm:text-3xl font-semibold text-green-400" id="stat-complete">-</div>
            </div>
            <div class="bg-dark-800 p-4 rounded-lg border border-gray-700">
                <h3 class="text-xs text-gray-400 uppercase tracking-wide mb-2">Errors</h3>
                <div class="text-2xl sm:text-3xl font-semibold text-red-400" id="stat-error">-</div>
            </div>
        </div>

        <!-- Sync Jobs Section -->
        <section class="mb-6">
            <h2 class="text-lg font-semibold text-gray-300 mb-4">Sync Jobs</h2>
            <div id="jobs-container">
                <div class="text-center py-10 text-gray-500">Loading...</div>
            </div>
        </section>
    </div>

    <script>
        const expandedJobs = new Set();
        let currentSort = { column: 'name', direction: 'asc' };
        const fileSorts = {}; // Per-job file sort state: { jobId: { column, direction } }
        let cachedJobs = [];
        let speedHistory = [];
        const maxSpeedHistory = 100;

        // Speed unit preference: 'bytes' (MB/s) or 'bits' (Mbps)
        let speedUnit = localStorage.getItem('speedUnit') || 'bytes';

        // Status order based on workflow (lower = earlier in flow)
        const jobStatusOrder = { downloading: 0, paused: 1, discovered: 2, pending: 3, syncing: 4, importing: 5, complete: 6, skipped: 7, error: 8 };
        const fileStatusOrder = { pending: 0, syncing: 1, complete: 2, skipped: 3, error: 4 };

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatSpeed(bytesPerSec) {
            if (!bytesPerSec || bytesPerSec === 0) return '-';
            if (speedUnit === 'bits') {
                // Convert bytes to bits (multiply by 8), use 1000-based units for bits
                const bitsPerSec = bytesPerSec * 8;
                const k = 1000;
                const sizes = ['bps', 'Kbps', 'Mbps', 'Gbps'];
                const i = Math.floor(Math.log(bitsPerSec) / Math.log(k));
                return parseFloat((bitsPerSec / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            return formatBytes(bytesPerSec) + '/s';
        }

        function toggleSpeedUnit() {
            speedUnit = speedUnit === 'bytes' ? 'bits' : 'bytes';
            localStorage.setItem('speedUnit', speedUnit);
            updateSpeedUnitButton();
            renderJobs(cachedJobs);
        }

        function updateSpeedUnitButton() {
            const btn = document.getElementById('speed-unit-btn');
            if (btn) {
                btn.textContent = speedUnit === 'bytes' ? 'MB/s' : 'Mbps';
                btn.title = `Click to switch to ${speedUnit === 'bytes' ? 'Mbps' : 'MB/s'}`;
            }
        }

        function formatDuration(seconds) {
            if (!seconds || seconds <= 0 || !isFinite(seconds)) return '--';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            if (hours > 24) {
                const days = Math.floor(hours / 24);
                return `${days}d ${hours % 24}h`;
            } else if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            }
            return `${secs}s`;
        }

        function updateSparkline(speed) {
            speedHistory.push(speed);
            if (speedHistory.length > maxSpeedHistory) speedHistory.shift();
            if (speedHistory.length < 2) {
                document.querySelector('#sparkline .line').setAttribute('d', '');
                document.querySelector('#sparkline .area').setAttribute('d', '');
                return;
            }
            const width = 120, height = 35, padding = 2;
            const maxSpeed = Math.max(...speedHistory, 1);
            const points = speedHistory.map((val, i) => ({
                x: padding + (i / (maxSpeedHistory - 1)) * (width - 2 * padding),
                y: height - padding - ((val / maxSpeed) * (height - 2 * padding))
            }));
            const linePath = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x.toFixed(1)} ${p.y.toFixed(1)}`).join(' ');
            const areaPath = linePath + ` L ${points[points.length - 1].x.toFixed(1)} ${height - padding} L ${points[0].x.toFixed(1)} ${height - padding} Z`;
            document.querySelector('#sparkline .line').setAttribute('d', linePath);
            document.querySelector('#sparkline .area').setAttribute('d', areaPath);
        }

        function updateTransferStatus(jobs) {
            let totalFiles = 0, completedFiles = 0, syncingFiles = 0, syncingJobs = 0, totalSpeed = 0;
            let downloadingOnSeedboxCount = 0, pausedOnSeedboxCount = 0;
            // Sync progress: only count bytes from jobs that are actually syncing or have synced
            // Don't include torrents still downloading on seedbox
            let syncTransferred = 0, syncTotalSize = 0;

            for (const job of jobs) {
                totalFiles += job.total_files || 0;

                // Check if this torrent is still downloading on seedbox
                const isDownloadingOnSeedbox = job.seedbox_state === 'downloading' && job.seedbox_progress < 1.0;
                const isPausedOnSeedbox = job.seedbox_state === 'paused' && job.seedbox_progress < 1.0;

                if (isDownloadingOnSeedbox) downloadingOnSeedboxCount++;
                if (isPausedOnSeedbox) pausedOnSeedboxCount++;

                if (job.status === 'syncing') {
                    syncingJobs++;
                    totalSpeed += job.bytes_per_sec || 0;
                    // Only count sync progress for jobs actively syncing
                    syncTotalSize += job.total_size || 0;
                    syncTransferred += job.completed_size || 0;
                } else if (job.status === 'complete' || job.status === 'importing') {
                    // Completed jobs count fully
                    syncTotalSize += job.total_size || 0;
                    syncTransferred += job.completed_size || 0;
                } else if (!isDownloadingOnSeedbox && !isPausedOnSeedbox && job.status !== 'discovered') {
                    // Ready to sync but not started - count in total but 0 transferred
                    syncTotalSize += job.total_size || 0;
                }
                // Note: torrents still downloading on seedbox don't count toward sync totals

                if (job.files && job.files.length > 0) {
                    for (const file of job.files) {
                        if (file.status === 'complete' || file.status === 'skipped') completedFiles++;
                        else if (file.status === 'syncing') syncingFiles++;
                    }
                } else if (job.status === 'complete') {
                    completedFiles += job.total_files || 0;
                }
            }

            document.getElementById('files-done').textContent = completedFiles;
            document.getElementById('files-total').textContent = totalFiles;
            updateSparkline(totalSpeed);
            const remainingBytes = syncTotalSize - syncTransferred;
            const etaSeconds = totalSpeed > 0 ? remainingBytes / totalSpeed : 0;

            const iconEl = document.getElementById('transfer-icon');
            if (syncingJobs > 0) {
                document.getElementById('files-progress').innerHTML = syncingFiles > 0 ? `<span class="text-yellow-400">(+${syncingFiles})</span>` : '';
                iconEl.textContent = '⬇';
                iconEl.title = 'Syncing: Transferring files from seedbox';
                iconEl.classList.add('animate-pulse-opacity');
                document.getElementById('transfer-rate').innerHTML = `<span class="text-green-500">${formatSpeed(totalSpeed)}</span>`;
                document.getElementById('transfer-eta').innerHTML = `<span>${formatDuration(etaSeconds)}</span>`;
            } else {
                document.getElementById('files-progress').textContent = '';
                iconEl.classList.remove('animate-pulse-opacity');
                document.getElementById('transfer-rate').innerHTML = '<span class="text-gray-500">Idle</span>';
                document.getElementById('transfer-eta').innerHTML = '<span>--</span>';

                // Determine icon based on state
                if (totalFiles > 0 && completedFiles === totalFiles) {
                    iconEl.textContent = '✓';
                    iconEl.title = 'Complete: All files synced';
                } else if (downloadingOnSeedboxCount > 0) {
                    iconEl.textContent = '⏳';
                    iconEl.title = 'Waiting: Downloads in progress on seedbox';
                } else if (pausedOnSeedboxCount > 0) {
                    iconEl.textContent = '⏸';
                    iconEl.title = 'Paused: Downloads paused on seedbox';
                } else {
                    iconEl.textContent = '●';
                    iconEl.title = 'Idle: Monitoring for new downloads';
                }
            }
            document.getElementById('total-transferred').textContent = formatBytes(syncTransferred);
            document.getElementById('total-size').textContent = formatBytes(syncTotalSize);
        }

        function getStateBadgeClasses(state) {
            const base = 'inline-block px-2 py-0.5 rounded text-xs uppercase font-medium cursor-help';
            const states = {
                'syncing': 'bg-yellow-500 text-black',
                'complete': 'bg-green-600 text-white',
                'error': 'bg-red-600 text-white',
                'pending': 'bg-gray-600 text-white',
                'discovered': 'bg-cyan-600 text-white',
                'importing': 'bg-purple-600 text-white',
                'skipped': 'bg-gray-600 text-white',
                'downloading': 'bg-blue-500 text-white',
                'paused': 'bg-orange-500 text-black',
            };
            return `${base} ${states[state] || states['pending']}`;
        }

        function getStateTooltip(state) {
            const tooltips = {
                'downloading': 'Downloading on seedbox',
                'paused': 'Paused on seedbox',
                'discovered': 'Discovered, waiting to sync',
                'pending': 'Pending sync',
                'syncing': 'Syncing files from seedbox',
                'importing': 'Triggering import in app',
                'complete': 'Fully synced and imported',
                'error': 'Error occurred',
                'skipped': 'Skipped',
            };
            return tooltips[state] || state;
        }

        // Get display state - combines sync state with seedbox state for better UX
        function getDisplayState(job) {
            // If seedbox is still downloading, show that state
            if (job.seedbox_state === 'downloading' && job.seedbox_progress < 1.0) {
                return 'downloading';
            }
            if (job.seedbox_state === 'paused' && job.seedbox_progress < 1.0) {
                return 'paused';
            }
            // Otherwise use the sync pipeline state
            return job.status;
        }

        // Get the appropriate progress for a job (seedbox download vs sync progress)
        function getJobProgress(job) {
            const isDownloadingOnSeedbox = job.seedbox_state === 'downloading' || job.seedbox_progress < 1.0;
            if (isDownloadingOnSeedbox && job.status !== 'syncing') {
                // Show seedbox download progress
                return { progress: job.seedbox_progress * 100, type: 'seedbox' };
            }
            // Show sync progress
            const syncProgress = job.total_size > 0 ? (job.completed_size / job.total_size * 100) : 0;
            return { progress: syncProgress, type: 'sync' };
        }

        function sortJobs(jobs, column, direction) {
            return [...jobs].sort((a, b) => {
                let aVal, bVal;
                switch (column) {
                    case 'name': aVal = a.name.toLowerCase(); bVal = b.name.toLowerCase(); break;
                    case 'category': aVal = (a.category || '').toLowerCase(); bVal = (b.category || '').toLowerCase(); break;
                    case 'downloader': aVal = (a.downloader || '').toLowerCase(); bVal = (b.downloader || '').toLowerCase(); break;
                    case 'files': aVal = a.total_files; bVal = b.total_files; break;
                    case 'status':
                        aVal = jobStatusOrder[getDisplayState(a)] ?? 99;
                        bVal = jobStatusOrder[getDisplayState(b)] ?? 99;
                        break;
                    case 'progress':
                        aVal = getJobProgress(a).progress;
                        bVal = getJobProgress(b).progress;
                        break;
                    case 'speed': aVal = a.bytes_per_sec || 0; bVal = b.bytes_per_sec || 0; break;
                    case 'size': aVal = a.total_size; bVal = b.total_size; break;
                    default: return 0;
                }
                if (aVal < bVal) return direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        function sortFiles(files, column, direction) {
            return [...files].sort((a, b) => {
                let aVal, bVal;
                switch (column) {
                    case 'name': aVal = a.path.toLowerCase(); bVal = b.path.toLowerCase(); break;
                    case 'status':
                        aVal = fileStatusOrder[a.status] ?? 99;
                        bVal = fileStatusOrder[b.status] ?? 99;
                        break;
                    case 'progress':
                        aVal = a.size > 0 ? a.transferred / a.size : 0;
                        bVal = b.size > 0 ? b.transferred / b.size : 0;
                        break;
                    case 'speed': aVal = a.bytes_per_sec || 0; bVal = b.bytes_per_sec || 0; break;
                    case 'size': aVal = a.size; bVal = b.size; break;
                    default: return 0;
                }
                if (aVal < bVal) return direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        function handleSort(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            renderJobs(cachedJobs);
        }

        function handleFileSort(jobId, column, event) {
            event.stopPropagation();
            if (!fileSorts[jobId]) {
                fileSorts[jobId] = { column: 'name', direction: 'asc' };
            }
            if (fileSorts[jobId].column === column) {
                fileSorts[jobId].direction = fileSorts[jobId].direction === 'asc' ? 'desc' : 'asc';
            } else {
                fileSorts[jobId].column = column;
                fileSorts[jobId].direction = 'asc';
            }
            renderJobs(cachedJobs);
        }

        async function toggleJob(jobId, event) {
            event.stopPropagation();
            // Don't allow expansion for single-file torrents
            const job = cachedJobs.find(j => j.id === jobId);
            if (job && job.total_files <= 1) return;

            if (expandedJobs.has(jobId)) {
                expandedJobs.delete(jobId);
            } else {
                expandedJobs.add(jobId);
                if (!fileSorts[jobId]) {
                    fileSorts[jobId] = { column: 'name', direction: 'asc' };
                }
                try {
                    const detail = await (await fetch(`/api/jobs/${jobId}`)).json();
                    const job = cachedJobs.find(j => j.id === jobId);
                    if (job) job.files = detail.files || [];
                } catch (e) { console.error('Failed to fetch job details:', e); }
            }
            renderJobs(cachedJobs);
        }

        async function fetchStats() {
            try {
                const data = await (await fetch('/api/stats')).json();
                document.getElementById('stat-total').textContent = data.total_tracked || 0;
                document.getElementById('stat-downloading').textContent = data.downloading_on_seedbox || 0;
                document.getElementById('stat-syncing').textContent = data.by_state?.syncing || 0;
                document.getElementById('stat-complete').textContent = data.by_state?.complete || 0;
                document.getElementById('stat-error').textContent = data.by_state?.error || 0;
                document.getElementById('status').textContent = 'Connected';
                document.getElementById('status').className = 'bg-green-600 text-white px-3 py-1 rounded-full text-sm';
            } catch (e) {
                document.getElementById('status').textContent = 'Disconnected';
                document.getElementById('status').className = 'bg-red-600 text-white px-3 py-1 rounded-full text-sm';
            }
        }

        function renderJobs(jobs) {
            const container = document.getElementById('jobs-container');
            const scrollPositions = {};
            document.querySelectorAll('[data-job-id]').forEach(el => {
                if (el.scrollTop > 0) scrollPositions[el.dataset.jobId] = el.scrollTop;
            });

            if (jobs.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-gray-500">No sync jobs</div>';
                return;
            }

            const sortedJobs = sortJobs(jobs, currentSort.column, currentSort.direction);
            const sortIcon = (col) => currentSort.column === col ? (currentSort.direction === 'asc' ? ' ▲' : ' ▼') : '';
            const fileSortIcon = (jobId, col) => {
                const fs = fileSorts[jobId];
                if (!fs || fs.column !== col) return '';
                return fs.direction === 'asc' ? ' ▲' : ' ▼';
            };

            // Mobile card view
            let mobileHtml = '<div class="sm:hidden space-y-3">';
            for (const job of sortedJobs) {
                const displayState = getDisplayState(job);
                const progressInfo = getJobProgress(job);
                const progress = progressInfo.progress;
                const isComplete = displayState === 'complete';
                const isDownloading = displayState === 'downloading';
                const isPaused = displayState === 'paused';
                const isExpanded = expandedJobs.has(job.id);
                const fileSort = fileSorts[job.id] || { column: 'name', direction: 'asc' };
                const sortedFiles = job.files ? sortFiles(job.files, fileSort.column, fileSort.direction) : [];

                // Progress bar color based on state
                let progressBarColor = 'bg-blue-500';
                if (isComplete) progressBarColor = 'bg-green-500';
                else if (isDownloading) progressBarColor = 'bg-blue-400';
                else if (isPaused) progressBarColor = 'bg-orange-400';
                else if (displayState === 'syncing') progressBarColor = 'bg-yellow-500';

                // Size display: show seedbox progress for downloading, sync progress for others
                const sizeDisplay = progressInfo.type === 'seedbox'
                    ? `${formatBytes(job.total_size * job.seedbox_progress)} / ${formatBytes(job.total_size)}`
                    : `${formatBytes(job.completed_size)} / ${formatBytes(job.total_size)}`;

                const canExpand = job.total_files > 1;
                mobileHtml += `
                    <div class="bg-dark-800 rounded-lg border border-gray-700 overflow-hidden">
                        <div class="p-4 ${canExpand ? 'cursor-pointer' : ''}" ${canExpand ? `onclick="toggleJob('${job.id}', event)"` : ''}>
                            <div class="flex justify-between items-start mb-2">
                                <span class="font-medium text-sm truncate flex-1 mr-2">${job.name}</span>
                                <span class="${getStateBadgeClasses(displayState)}" title="${getStateTooltip(displayState)}">${displayState}</span>
                            </div>
                            <div class="flex items-center gap-2 mb-2 flex-wrap">
                                <span class="bg-dark-700 text-gray-400 px-2 py-0.5 rounded text-xs">${job.downloader || '-'}</span>
                                <span class="bg-dark-700 text-gray-400 px-2 py-0.5 rounded text-xs">${job.category || 'uncategorized'}</span>
                                <span class="text-gray-400 text-xs">${job.total_files} file${job.total_files !== 1 ? 's' : ''}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="flex-1 bg-gray-700 rounded-full h-2 overflow-hidden">
                                    <div class="h-full ${progressBarColor} transition-all" style="width: ${progress}%"></div>
                                </div>
                                <span class="text-xs text-gray-400 w-10 text-right">${Math.round(progress)}%</span>
                            </div>
                            <div class="text-xs text-gray-400 mt-2">${sizeDisplay}${job.bytes_per_sec ? ` • ${formatSpeed(job.bytes_per_sec)}` : ''}</div>
                        </div>
                        ${isExpanded && sortedFiles.length > 0 ? `
                            <div class="border-t border-gray-700 bg-dark-500">
                                <div class="flex gap-2 p-2 border-b border-gray-700 text-xs">
                                    <button onclick="handleFileSort('${job.id}', 'name', event)" class="px-2 py-1 rounded ${fileSort.column === 'name' ? 'bg-dark-700 text-white' : 'text-gray-400 hover:text-white'}">Name${fileSortIcon(job.id, 'name')}</button>
                                    <button onclick="handleFileSort('${job.id}', 'status', event)" class="px-2 py-1 rounded ${fileSort.column === 'status' ? 'bg-dark-700 text-white' : 'text-gray-400 hover:text-white'}">Status${fileSortIcon(job.id, 'status')}</button>
                                    <button onclick="handleFileSort('${job.id}', 'progress', event)" class="px-2 py-1 rounded ${fileSort.column === 'progress' ? 'bg-dark-700 text-white' : 'text-gray-400 hover:text-white'}">Progress${fileSortIcon(job.id, 'progress')}</button>
                                </div>
                                <div class="max-h-60 overflow-y-auto" data-job-id="${job.id}">
                                    ${sortedFiles.map(f => `
                                        <div class="px-4 py-2 border-b border-gray-700/50 last:border-0">
                                            <div class="flex justify-between items-center">
                                                <span class="text-sm text-gray-300 truncate flex-1 mr-2">${f.path.split('/').pop()}</span>
                                                <span class="${getStateBadgeClasses(f.status)}">${f.status}</span>
                                            </div>
                                            <div class="text-xs text-gray-500 mt-1">${formatBytes(f.transferred)} / ${formatBytes(f.size)} ${f.bytes_per_sec ? `• ${formatSpeed(f.bytes_per_sec)}` : ''}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            mobileHtml += '</div>';

            // Desktop table view
            let desktopHtml = `
                <div class="hidden sm:block overflow-x-auto">
                    <table class="w-full bg-dark-800 rounded-lg border border-gray-700 border-collapse">
                        <thead>
                            <tr class="bg-dark-700">
                                <th class="px-4 py-3 text-left text-xs uppercase text-gray-400 cursor-pointer hover:bg-dark-600 transition-colors rounded-tl-lg" onclick="handleSort('name')">Name${sortIcon('name')}</th>
                                <th class="px-4 py-3 text-left text-xs uppercase text-gray-400 cursor-pointer hover:bg-dark-600 transition-colors hidden xl:table-cell" onclick="handleSort('downloader')">Downloader${sortIcon('downloader')}</th>
                                <th class="px-4 py-3 text-left text-xs uppercase text-gray-400 cursor-pointer hover:bg-dark-600 transition-colors hidden lg:table-cell" onclick="handleSort('category')">Category${sortIcon('category')}</th>
                                <th class="px-4 py-3 text-center text-xs uppercase text-gray-400 cursor-pointer hover:bg-dark-600 transition-colors hidden md:table-cell" onclick="handleSort('files')">Files${sortIcon('files')}</th>
                                <th class="px-4 py-3 text-left text-xs uppercase text-gray-400 cursor-pointer hover:bg-dark-600 transition-colors" onclick="handleSort('status')">Status${sortIcon('status')}</th>
                                <th class="px-4 py-3 text-left text-xs uppercase text-gray-400 cursor-pointer hover:bg-dark-600 transition-colors" onclick="handleSort('progress')">Progress${sortIcon('progress')}</th>
                                <th class="px-4 py-3 text-right text-xs uppercase text-gray-400 cursor-pointer hover:bg-dark-600 transition-colors hidden md:table-cell" onclick="handleSort('speed')">Speed${sortIcon('speed')}</th>
                                <th class="px-4 py-3 text-left text-xs uppercase text-gray-400 cursor-pointer hover:bg-dark-600 transition-colors hidden lg:table-cell" onclick="handleSort('size')">Size${sortIcon('size')}</th>
                                <th class="px-4 py-3 text-center text-xs uppercase text-gray-400 rounded-tr-lg w-10"></th>
                            </tr>
                        </thead>
                        <tbody>`;

            for (const job of sortedJobs) {
                const isExpanded = expandedJobs.has(job.id);
                const displayState = getDisplayState(job);
                const progressInfo = getJobProgress(job);
                const progress = progressInfo.progress;
                const isComplete = displayState === 'complete';
                const isDownloading = displayState === 'downloading';
                const isPaused = displayState === 'paused';
                const fileSort = fileSorts[job.id] || { column: 'name', direction: 'asc' };
                const sortedFiles = job.files ? sortFiles(job.files, fileSort.column, fileSort.direction) : [];

                // Progress bar color based on state
                let progressBarColor = 'bg-blue-500';
                if (isComplete) progressBarColor = 'bg-green-500';
                else if (isDownloading) progressBarColor = 'bg-blue-400';
                else if (isPaused) progressBarColor = 'bg-orange-400';
                else if (displayState === 'syncing') progressBarColor = 'bg-yellow-500';

                // Size display: show seedbox progress for downloading, sync progress for others
                const sizeDisplay = progressInfo.type === 'seedbox'
                    ? `${formatBytes(job.total_size * job.seedbox_progress)} / ${formatBytes(job.total_size)}`
                    : `${formatBytes(job.completed_size)} / ${formatBytes(job.total_size)}`;

                const canExpandDesktop = job.total_files > 1;
                desktopHtml += `
                    <tr class="border-t border-gray-700 ${canExpandDesktop ? 'cursor-pointer hover:bg-dark-600' : ''} transition-colors ${isExpanded ? 'bg-dark-600' : ''}" ${canExpandDesktop ? `onclick="toggleJob('${job.id}', event)"` : ''}>
                        <td class="px-4 py-3 truncate max-w-xs" title="${job.name}">${job.name}</td>
                        <td class="px-4 py-3 hidden xl:table-cell"><span class="bg-dark-700 text-gray-400 px-2 py-0.5 rounded text-xs">${job.downloader || '-'}</span></td>
                        <td class="px-4 py-3 hidden lg:table-cell"><span class="bg-dark-700 text-gray-400 px-2 py-0.5 rounded text-xs">${job.category || 'uncategorized'}</span></td>
                        <td class="px-4 py-3 text-center hidden md:table-cell">${job.total_files}</td>
                        <td class="px-4 py-3"><span class="${getStateBadgeClasses(displayState)}" title="${getStateTooltip(displayState)}">${displayState}</span></td>
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                <div class="flex-1 bg-gray-700 rounded-full h-2 overflow-hidden min-w-16">
                                    <div class="h-full ${progressBarColor} transition-all" style="width: ${progress}%"></div>
                                </div>
                                <span class="text-xs text-gray-400 w-10">${Math.round(progress)}%</span>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-right text-sm text-gray-400 hidden md:table-cell">${formatSpeed(job.bytes_per_sec)}</td>
                        <td class="px-4 py-3 text-sm hidden lg:table-cell">${sizeDisplay}</td>
                        <td class="px-4 py-3 text-center">${canExpandDesktop ? `<span class="transition-transform inline-block ${isExpanded ? 'rotate-180' : ''}">▼</span>` : ''}</td>
                    </tr>`;

                if (isExpanded && sortedFiles.length > 0) {
                    desktopHtml += `
                        <tr class="bg-dark-500">
                            <td colspan="9" class="p-4">
                                <div class="bg-dark-800 rounded-lg border border-gray-700 overflow-hidden">
                                    <table class="w-full">
                                        <thead>
                                            <tr class="bg-dark-700">
                                                <th class="px-4 py-2 text-left text-xs uppercase text-gray-400 cursor-pointer hover:bg-dark-600 transition-colors" onclick="handleFileSort('${job.id}', 'name', event)">Name${fileSortIcon(job.id, 'name')}</th>
                                                <th class="px-4 py-2 text-left text-xs uppercase text-gray-400 cursor-pointer hover:bg-dark-600 transition-colors" onclick="handleFileSort('${job.id}', 'status', event)">Status${fileSortIcon(job.id, 'status')}</th>
                                                <th class="px-4 py-2 text-left text-xs uppercase text-gray-400 cursor-pointer hover:bg-dark-600 transition-colors" onclick="handleFileSort('${job.id}', 'progress', event)">Progress${fileSortIcon(job.id, 'progress')}</th>
                                                <th class="px-4 py-2 text-right text-xs uppercase text-gray-400 cursor-pointer hover:bg-dark-600 transition-colors" onclick="handleFileSort('${job.id}', 'speed', event)">Speed${fileSortIcon(job.id, 'speed')}</th>
                                                <th class="px-4 py-2 text-right text-xs uppercase text-gray-400 cursor-pointer hover:bg-dark-600 transition-colors hidden lg:table-cell" onclick="handleFileSort('${job.id}', 'size', event)">Size${fileSortIcon(job.id, 'size')}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${sortedFiles.map(f => {
                                                const fileProgress = f.size > 0 ? (f.transferred / f.size * 100) : 0;
                                                const fileComplete = f.status === 'complete' || f.status === 'skipped';
                                                return `
                                                    <tr class="border-t border-gray-700/50 hover:bg-dark-600">
                                                        <td class="px-4 py-2 truncate text-gray-300 text-sm max-w-xs" title="${f.path}">${f.path.split('/').pop()}</td>
                                                        <td class="px-4 py-2"><span class="${getStateBadgeClasses(f.status)}">${f.status}</span></td>
                                                        <td class="px-4 py-2">
                                                            <div class="flex items-center gap-2">
                                                                <div class="flex-1 bg-gray-700 rounded-full h-1.5 overflow-hidden min-w-12">
                                                                    <div class="h-full ${fileComplete ? 'bg-green-500' : 'bg-blue-500'} transition-all" style="width: ${fileProgress}%"></div>
                                                                </div>
                                                                <span class="text-xs text-gray-400 w-10">${Math.round(fileProgress)}%</span>
                                                            </div>
                                                        </td>
                                                        <td class="px-4 py-2 text-right text-sm text-gray-400">${formatSpeed(f.bytes_per_sec)}</td>
                                                        <td class="px-4 py-2 text-right text-sm text-gray-400 hidden lg:table-cell">${formatBytes(f.transferred)} / ${formatBytes(f.size)}</td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                    <div class="max-h-64 overflow-y-auto" data-job-id="${job.id}"></div>
                                </div>
                            </td>
                        </tr>`;
                }
            }
            desktopHtml += '</tbody></table></div>';

            container.innerHTML = mobileHtml + desktopHtml;

            Object.entries(scrollPositions).forEach(([jobId, scrollTop]) => {
                const el = document.querySelector(`[data-job-id="${jobId}"]`);
                if (el) el.scrollTop = scrollTop;
            });
        }

        async function fetchJobs() {
            try {
                const jobs = await (await fetch('/api/jobs')).json();
                for (const job of jobs) {
                    const cached = cachedJobs.find(j => j.id === job.id);
                    if (cached && cached.files) job.files = cached.files;
                }
                for (const job of jobs) {
                    if (job.status === 'syncing' && !job.files) {
                        try {
                            const detail = await (await fetch(`/api/jobs/${job.id}`)).json();
                            job.files = detail.files || [];
                        } catch (e) { console.error('Failed to fetch job details:', e); }
                    }
                }
                cachedJobs = jobs;
                updateTransferStatus(jobs);
                renderJobs(jobs);
            } catch (e) { console.error('Failed to fetch jobs:', e); }
        }

        async function refreshExpandedJobFiles() {
            const jobsToRefresh = new Set(expandedJobs);
            for (const job of cachedJobs) {
                if (job.status === 'syncing') jobsToRefresh.add(job.id);
            }
            for (const jobId of jobsToRefresh) {
                try {
                    const detail = await (await fetch(`/api/jobs/${jobId}`)).json();
                    const job = cachedJobs.find(j => j.id === jobId);
                    if (job) job.files = detail.files || [];
                } catch (e) { console.error('Failed to refresh job details:', e); }
            }
        }

        async function fetchSpeedHistory() {
            try {
                const history = await (await fetch('/api/speed-history')).json();
                speedHistory = history.map(h => h.speed);
                if (speedHistory.length > 0) updateSparkline(speedHistory[speedHistory.length - 1]);
            } catch (e) { console.error('Failed to fetch speed history:', e); }
        }

        async function refresh() {
            await fetchStats();
            await refreshExpandedJobFiles();
            await fetchJobs();
        }

        // Initialize on page load
        updateSpeedUnitButton();
        fetchSpeedHistory().then(() => refresh());
        setInterval(refresh, 3000);
    </script>
</body>
</html>
